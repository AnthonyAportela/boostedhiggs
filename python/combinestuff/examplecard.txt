#name of datacard
##  /uscms_data/d3/mquinnan/CMSSW_8_0_28/src/AnalysisMethods/macros/4t_veto/datacards/NNtight/tttt_1lep_tttt_t1_sd1_ht_gr1400.txt 


---
imax: 1 #number of observables (or channels)
jmax: 7 #number of backgrounds
kmax: 8 #number of nuisance parameters (sources of systematic uncertainties)
---


---
bin                  2  #defines the label used for each channel
observation          0  #listed the events observed
---


#The bin line identifies the channel the column is referring to. It goes from 1 to the imax declared above.
#The first process line contains the labels of the various sources
#The second process line must have a positive number for backgrounds, and 0 or a negative number for the signals. You should use different process ids for different processes.
#The last line, rate, tells the expected yield of events in the specified bin and process
## we list the expected events for signal and all backgrounds in the bins
---
bin                 2             2             2             2             2             2             2             2
process         tttt         ttbar_nl         QCD         ttW_wjets         tWZ_ttZ         ttH         znunu         diboson
process             0             1             2             3             4             5             6             7
rate            1.776         26.26         0.0         1.152         0.042         0.557         0.0         0.0
---


## then we list the independent sources of uncertainties, and give their effect (syst. error) on each process and bin
#the first columns is a label identifying the uncertainty
#the second column identifies the type of distribution used
#then there are (#channels)*(#processes) columns reporting the relative effect of the systematic uncertainty on the rate of each process in each channel. The columns are aligned with the ones in the previous lines declaring bins, processes and rates
---
tttt_unc_2         lnN         1.14         -         -         -         -         -         -         -         
ttbar_nl_unc_2         lnN         -         1.11         -         -         -         -         -         -         
QCD_unc_2         lnN         -         -         0.0         -         -         -         -         -         
ttW_wjets_unc_2         lnN         -         -         -         1.26         -         -         -         -         
tWZ_ttZ_unc_2         lnN         -         -         -         -         17.21         -         -         -         
ttH_unc_2         lnN         -         -         -         -         -         1.14         -         -         
znunu_unc_2         lnN         -         -         -         -         -         -         0.0         -         
diboson_unc_2         lnN         -         -         -         -         -         -         -         0.0         
---

#for shape analysis need to add:
#A new block of lines defining how channels and processes are mapped into shapes
#The block for systematics that can contain also rows with shape uncertainties
#Within each channel, all histograms must have the same binning.
##The normalization of the data histogram must correspond to the number of observed evenThe normalization of the expected histograms must match the expected yields

# The block of lines defining the mapping (first block in the datacard) contains one or more rows in the form:
# shapes process channel file histogram [histogram_with_systematics]
shapes * * simple-shapes-TH1_input.root $PROCESS $PROCESS_$SYSTEMATIC
# In this line

# process is any one the process names, or * for all processes, or data_obs for the observed data
# channel is any one the process names, or * for all channels
# file, histogram and histogram_with_systematics identify the names of the files and of the histograms within the file, after doing some replacements (if any are found):
# $PROCESS is replaced with the process name (or "data_obs" for the observed data)
# $CHANNEL is replaced with the channel name
# $SYSTEMATIC is replaced with the name of the systematic + (Up, Down)
# $MASS is replaced with the higgs mass value which is passed as option in the command line used to run the limit toolThe block of lines defining the mapping (first block in the datacard) contains one or more rows in the form

# # In addition, user defined keywords can be included to be replaced. Any word in the datacard $WORD will be replaced by VALUE when including the option --keyword-value WORD=VALUE. The option can be repeated multiple times for multiple keyword

# For each shape uncertainty and process/channel affected by it, two additional input shapes have to be provided, obtained shifting that parameter up and down by one standard deviation. When building the likelihood, each shape uncertainty is associated to a nuisance parameter taken from a unit gaussian distribution, which is used to interpolate or extrapolate using the specified histograms.

# For each given source of shape uncertainty, in the part of the datacard containing shape uncertainties (last block), there must be a row

# name shape effect_for_each_process_and_channel
# The effect can be "-" or 0 for no effect, 1 for normal effect, and possibly something different from 1 to test larger or smaller effects (in that case, the unit gaussian is scaled by that factor before using it as parameter for the interpolation)



#datacard example:

imax 1
jmax 1
kmax *
---------------
shapes * * simple-shapes-TH1_input.root $PROCESS $PROCESS_$SYSTEMATIC
---------------
bin bin1
observation 85
------------------------------
bin             bin1       bin1
process         signal     background
process         0          1
rate            10         100
--------------------------------
lumi     lnN    1.10       1.0
bgnorm   lnN    1.00       1.3
alpha  shapeN2    -           1   uncertainty on background shape and normalization
sigma  shapeN2    0.5         -   uncertainty on signal resolution. Assume the histogram is a 2 sigma shift, so divide the unit gaussian by 2 before doing the interpolation

# There are two options for the interpolation algorithm in the "shape" uncertainty. Putting shape will result in a of the fraction of events in each bin - i.e the histograms are first normalised before interpolation. Putting shapeN while instead base the interpolation on the logs of the fraction in each bin. For both shape and shapeN, the total normalisation is interpolated using an asymmetric log-normal so that the effect of the systematic on both the shape and normalisation are accounted for.


#original datacard example:
##  /uscms_data/d3/mquinnan/CMSSW_8_0_28/src/AnalysisMethods/macros/4t_veto/datacards/newcards/1lep_NNflipped/tttt_1lep_tttt_t1_sd0_ht_800-1400_njets_11-13.txt


---
imax: 1
jmax: 7
kmax: 8
---

---
bin                  5
observation          0
---

## we list the expected events for signal and all backgrounds in the bins
---
bin                 5             5             5             5             5             5             5             5
process         tttt         ttbar_nl         QCD         ttW_wjets         tWZ_ttZ         ttH         znunu         diboson
process             0             1             2             3             4             5             6             7
rate            3.777         154.052         0.0         3.738         0.0         2.61         0.172         0.0
---

## then we list the independent sources of uncertainties, and give their effect (syst. error) on each process and bin
---
tttt_unc_5         lnN         1.1         -         -         -         -         -         -         -
ttbar_nl_unc_5         lnN         -         1.05         -         -         -         -         -         -
QCD_unc_5         lnN         -         -         0.0         -         -         -         -         -
ttW_wjets_unc_5         lnN         -         -         -         1.19         -         -         -         -
tWZ_ttZ_unc_5         lnN         -         -         -         -         0.0         -         -         -
ttH_unc_5         lnN         -         -         -         -         -         1.06         -         -
znunu_unc_5         lnN         -         -         -         -         -         -         2.0         -
diboson_unc_5         lnN         -         -         -         -         -         -         -         0.0
###adding UNCORRELATED dummy systematics of 20% to backgrounds
dummytttt5            lnN       1.2        -        -        -        -        -        -        -
dummyttbar5            lnN       -        1.2        -        -        -        -        -        -
dummyQCD5              lnN       -        -        1.2        -        -        -        -        -
dummyttWwj5            lnN       -        -        -        1.2        -        -        -        -
dummytWZttZ5           lnN       -        -        -        -        1.2        -        -        -
dummyttH5              lnN       -        -        -        -        -        1.2        -        -
dummyznunu5            lnN       -        -        -        -        -        -        1.2        -
dummydb5               lnN       -        -        -        -        -        -        -        1.2
